@page "/profile"
@inject UserService UserService
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation
@using UserManagementFE.Services
@using UserManagementFE.Models
@using System.ComponentModel.DataAnnotations

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">Thông Tin Cá Nhân</h3>
                </div>
                <div class="card-body">
                    @if (profileModel != null)
                    {
                        <EditForm Model="@profileModel" OnValidSubmit="HandleEditProfile">
                            <DataAnnotationsValidator />
                            <div class="row">
                                <!-- Cột 1 -->
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label class="form-label">Tên đăng nhập:</label>
                                        <InputText class="form-control" @bind-Value="profileModel.Username" disabled />
                                        <ValidationMessage For="@(() => profileModel.Username)" class="text-danger" />
                                    </div>
                                    <div class="form-group mb-3">
                                        <label class="form-label">Họ tên:</label>
                                        <InputText class="form-control" @bind-Value="profileModel.HoTen" disabled />
                                        <ValidationMessage For="@(() => profileModel.HoTen)" class="text-danger" />
                                    </div>
                                    <div class="form-group mb-3">
                                        <label class="form-label">Ngày sinh:</label>
                                        <InputDate class="form-control" @bind-Value="profileModel.NgaySinh" disabled />
                                        <ValidationMessage For="@(() => profileModel.NgaySinh)" class="text-danger" />
                                    </div>
                                    <div class="form-group mb-3">
                                        <label class="form-label">Giới tính:</label>
                                        <InputSelect class="form-control" @bind-Value="profileModel.GioiTinh" disabled>
                                            <option value="">Chọn giới tính</option>
                                            <option value="Nam">Nam</option>
                                            <option value="Nữ">Nữ</option>
                                            <option value="Khác">Khác</option>
                                        </InputSelect>
                                        <ValidationMessage For="@(() => profileModel.GioiTinh)" class="text-danger" />
                                    </div>
                                    <div class="form-group mb-3">
                                        <label class="form-label">Số CCCD:</label>
                                        <InputText class="form-control" @bind-Value="profileModel.SoCCCD" disabled />
                                        <ValidationMessage For="@(() => profileModel.SoCCCD)" class="text-danger" />
                                    </div>
                                    <div class="form-group mb-3">
                                        <label class="form-label">Số điện thoại:</label>
                                        <InputText class="form-control" @bind-Value="profileModel.Sdt" />
                                        <ValidationMessage For="@(() => profileModel.Sdt)" class="text-danger" />
                                    </div>
                                    <div class="form-group mb-3">
                                        <label class="form-label">Email:</label>
                                        <InputText class="form-control" @bind-Value="profileModel.Email" />
                                        <ValidationMessage For="@(() => profileModel.Email)" class="text-danger" />
                                    </div>
                                </div>
                                <!-- Cột 2 -->
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label class="form-label">Địa chỉ thường trú:</label>
                                        <InputText class="form-control" @bind-Value="profileModel.DiaChiThuongTru" disabled />
                                        <ValidationMessage For="@(() => profileModel.DiaChiThuongTru)" class="text-danger" />
                                    </div>
                                    <div class="form-group mb-3">
                                        <label class="form-label">Địa chỉ tạm trú:</label>
                                        <InputText class="form-control" @bind-Value="profileModel.DiaChiTamTru" />
                                        <ValidationMessage For="@(() => profileModel.DiaChiTamTru)" class="text-danger" />
                                    </div>
                                    <div class="form-group mb-3">
                                        <label class="form-label">Nghề nghiệp:</label>
                                        <InputText class="form-control" @bind-Value="profileModel.NgheNghiep" />
                                        <ValidationMessage For="@(() => profileModel.NgheNghiep)" class="text-danger" />
                                    </div>
                                    <div class="form-group mb-3">
                                        <label class="form-label">Tình trạng hôn nhân:</label>
                                        <InputSelect class="form-control" @bind-Value="profileModel.HonNhan">
                                            <option value="">Chọn tình trạng</option>
                                            <option value="Độc thân">Độc thân</option>
                                            <option value="Đã kết hôn">Đã kết hôn</option>
                                            <option value="Ly hôn">Ly hôn</option>
                                        </InputSelect>
                                        <ValidationMessage For="@(() => profileModel.HonNhan)" class="text-danger" />
                                    </div>
                                    <div class="form-group mb-3">
                                        <label class="form-label">Bằng lái xe:</label>
                                        <InputText class="form-control" @bind-Value="profileModel.BangLaiXe" />
                                        <ValidationMessage For="@(() => profileModel.BangLaiXe)" class="text-danger" />
                                    </div>
                                    <div class="form-group mb-3">
                                        <label class="form-label">Số tài khoản ngân hàng:</label>
                                        <InputText class="form-control" @bind-Value="profileModel.SoTKNganHang" />
                                        <ValidationMessage For="@(() => profileModel.SoTKNganHang)" class="text-danger" />
                                    </div>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary w-100 mt-3">Cập Nhật</button>
                        </EditForm>

                        @if (!string.IsNullOrEmpty(successMessage))
                        {
                            <div class="alert alert-success mt-3">@successMessage</div>
                        }
                        @if (!string.IsNullOrEmpty(errorMessage))
                        {
                            <div class="alert alert-danger mt-3">@errorMessage</div>
                        }
                    }
                    else
                    {
                        <div class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Đang tải...</span>
                            </div>
                            <p>Đang tải...</p>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@code {

    private ProfileModel? profileModel;
    private string successMessage = string.Empty;
    private string errorMessage = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        try
        {
             Console.WriteLine("Getting profile...");
             profileModel = await UserService.GetProfileAsync();
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
            if (ex.Message.Contains("401"))
            {
                Navigation.NavigateTo("/login");
            }
        }
    }

    private async Task HandleEditProfile()
    {
        if (profileModel == null)
        {
            errorMessage = "Không thể cập nhật vì thông tin người dùng không tồn tại.";
            return;
        }

        try
        {
            var response = await UserService.EditProfileAsync(profileModel);
            await JSRuntime.InvokeVoidAsync("alert", "Cập nhật thông tin người dùng thành công!");
            //successMessage = response;
            errorMessage = string.Empty;
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
            successMessage = string.Empty;
        }
    }
}